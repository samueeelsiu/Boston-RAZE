<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Building Demolition Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@4.2.7/build/index.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .error-message {
            background: #fee;
            border-left: 4px solid #c00;
            padding: 15px;
            margin: 20px 0;
            color: #800;
        }

        .data-note {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        .methodology {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-top: 20px;
        }

        .methodology h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .methodology p {
            color: #555;
            margin-bottom: 10px;
        }

        .stats-value {
            font-weight: bold;
            color: #3498db;
        }

        .controls {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .control-group label {
            display: inline-block;
            margin-right: 8px;
            font-weight: 500;
        }

        select, input[type="radio"] {
            margin-right: 5px;
        }

        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .radio-group {
            display: inline-block;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .radio-group input[type="radio"] {
            margin-right: 5px;
        }

        .radio-group label {
            margin-right: 15px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-container {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container.hidden {
            display: none;
        }

        /* Heatmap styles */
        .heatmap-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            font-size: 0.9em;
        }

        .heatmap-table th {
            background: #2c3e50;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .heatmap-table th.material-header {
            text-align: left;
            padding-left: 15px;
            min-width: 120px;
        }

        .heatmap-table td {
            padding: 8px;
            text-align: center;
            position: relative;
            min-width: 80px;
            transition: all 0.2s ease;
        }

        .heatmap-table td.material-name {
            font-weight: 500;
            background: #f8f9fa;
            text-align: left;
            padding-left: 15px;
            color: #2c3e50;
            border-right: 2px solid #dee2e6;
        }

        .heatmap-cell {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: 500;
        }

        .heatmap-table tr:hover td:not(.material-name) {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-gradient {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gradient-bar {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, rgb(240, 249, 33), rgb(253, 206, 2), rgb(254, 153, 61), rgb(251, 127, 88), rgb(235, 101, 105), rgb(216, 77, 120), rgb(196, 54, 136), rgb(172, 33, 152), rgb(144, 13, 163), rgb(114, 1, 168), rgb(82, 2, 165), rgb(47, 7, 164), rgb(13, 8, 135));
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .view-toggle button:hover:not(.active) {
            background: #f8f9fa;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chart-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        canvas {
            max-height: 400px;
        }

        .material-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .material-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        .material-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .city-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }

        .city-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .city-count {
            color: #666;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Boston Building Demolition Analysis</h1>
            <p class="subtitle" id="subtitle">Data From NSI enhanced USA Structure(MA) dataset</p>
            
            <div class="data-note">
                <strong>Important:</strong> This analysis covers demolition data from the Boston area only.
                The data is extracted from the NSI enhanced USA Structure(MA) dataset but focuses exclusively on the Greater Boston region.
            </div>
            
            <div class="methodology">
                <h3>Data Overview</h3>
                <p>
                    Source dataset: <span class="stats-value" id="totalMABuildings">-</span> Massachusetts buildings<br>
                    <strong style="color: #c00;">Filter Applied: Buildings built ≥1940</strong><br>
                    Year built range: <span class="stats-value" id="yearBuiltRange">-</span><br>
                    Boston area demolitions: <span class="stats-value" id="bostonDemolitions">-</span> records<br>
                    After cleaning: <span class="stats-value" id="validRecords">-</span> unique buildings<br>
                    Demolition date range: <span class="stats-value" id="dateRange">-</span>
                </p>
                <p style="margin-top: 10px;">
                    <strong>Demolition Types:</strong><br>
                    • RAZE: Complete structure demolition<br>
                    • EXTDEM: Exterior demolition<br>
                    • INTDEM: Interior demolition
                </p>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Loading data...</div>

        <div id="mainContent" style="display: none;">
            <div class="controls">
                <div class="control-group">
                    <label><strong>Demolition Type:</strong></label>
                    <div class="radio-group">
                        <label><input type="radio" name="demolitionView" value="all" onchange="updateDemolitionView()"> All Types</label>
                        <label><input type="radio" name="demolitionView" value="RAZE" checked onchange="updateDemolitionView()"> RAZE Only</label>
                        <label><input type="radio" name="demolitionView" value="EXTDEM" onchange="updateDemolitionView()"> EXTDEM Only</label>
                        <label><input type="radio" name="demolitionView" value="INTDEM" onchange="updateDemolitionView()"> INTDEM Only</label>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Lifespan Bin Size:</label>
                    <select id="lifespanBinSize" onchange="updateVisualization()">
                        <option value="10">10 Years</option>
                        <option value="20" selected>20 Years</option>
                        <option value="25">25 Years</option>
                        <option value="30">30 Years</option>
                        <option value="50">50 Years</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Display:</label>
                    <select id="viewMode" onchange="updateVisualization()">
                        <option value="count">Count</option>
                        <option value="percentage">Percentage</option>
                    </select>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Demolitions</div>
                    <div class="stat-number" id="totalDemo">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" id="avgLifespanLabel">Average Lifespan</div>
                    <div class="stat-number" id="avgLifespan">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">EXTDEM</div>
                    <div class="stat-number" id="extdemCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">INTDEM</div>
                    <div class="stat-number" id="intdemCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">RAZE</div>
                    <div class="stat-number" id="razeCount">-</div>
                </div>
            </div>
            
            <div class="view-toggle">
                <h3 style="margin-right: 20px; color: #2c3e50; align-self: center;">Material Analysis View:</h3>
                <button id="heatmapBtn" class="active">Heatmap View</button>
                <button id="stackedBtn">Stacked Bar Chart</button>
            </div>

            <div id="heatmapContainer" class="chart-container">
                <h2 class="chart-title">Material vs Lifespan Heatmap</h2>
                <p class="chart-description">Heatmap showing demolition counts for each material-lifespan combination</p>
                <div id="heatmapContent"></div>
            </div>
            
            <div id="allChartContainer" class="chart-container hidden">
                <h2 class="chart-title">All Types: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (All demolition types combined)</p>
                <canvas id="allChart"></canvas>
            </div>

            <div id="razeChartContainer" class="chart-container hidden">
                <h2 class="chart-title">RAZE: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (Complete demolition)</p>
                <canvas id="razeChart"></canvas>
            </div>

            <div id="extdemChartContainer" class="chart-container hidden">
                <h2 class="chart-title">EXTDEM: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (Exterior demolition)</p>
                <canvas id="extdemChart"></canvas>
            </div>

            <div id="intdemChartContainer" class="chart-container hidden">
                <h2 class="chart-title">INTDEM: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (Interior demolition)</p>
                <canvas id="intdemChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Demolitions by Year</h2>
                <canvas id="yearlyChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Building Lifespan Distribution</h2>
                <canvas id="lifespanChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Material Type Statistics</h2>
                <table class="material-table" id="materialTable">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Count</th>
                            <th>Avg Lifespan</th>
                            <th>INTDEM</th>
                            <th>EXTDEM</th>
                            <th>RAZE</th>
                        </tr>
                    </thead>
                    <tbody id="materialTableBody"></tbody>
                </table>
            </div>

            <div class="chart-container">
                <h2 class="chart-title" id="boxplotTitle">Building Lifespan by Material Type</h2>
                <p class="chart-description" id="boxplotDescription">Box plot showing the distribution of building lifespans for each material type</p>
                <canvas id="boxplotChart" style="max-height: 500px;"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Demolitions by City</h2>
                <div class="city-grid" id="cityGrid"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        Data Source: NSI Enhanced USA Structure dataset
    </div>

    <script>
        let currentData = null;
        let charts = {};
        let currentVisualization = 'heatmap'; // Default to heatmap

        // Color scheme for stacked bar charts (Darkest for largest, lightest for smallest)
        function getLifespanColors(count) {
            // Plasma colormap reversed for "darkest for largest"
            const plasmaColorsReversed = [
                [240, 249, 33],    // Bright yellow (min)
                [248, 230, 33],
                [253, 206, 2],
                [254, 180, 31],
                [254, 153, 61],
                [251, 127, 88],
                [235, 101, 105],
                [216, 77, 120],
                [196, 54, 136],
                [172, 33, 152],
                [144, 13, 163],
                [114, 1, 168],
                [82, 2, 165],
                [47, 7, 164],
                [13, 8, 135]      // Dark purple (max)
            ];
            
            const colors = [];
            for (let i = 0; i < count; i++) {
                const idx = Math.floor((i / count) * plasmaColorsReversed.length);
                const rgb = plasmaColorsReversed[Math.min(idx, plasmaColorsReversed.length - 1)];
                colors.push(`rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.85)`);
            }
            return colors.reverse(); 
        }

        // Modified Plasma colormap for heatmap with LINEAR scale (Light yellow for min, Dark purple for max)
        function getPlasmaColor(value, maxValue) {
            if (value === 0) return '#f0f0f0'; // Light gray for zero
            
            // Use LINEAR scale instead of log scale
            const intensity = maxValue > 0 ? value / maxValue : 0;
            
            const plasmaColors = [
                [240, 249, 33], [248, 230, 33], [253, 206, 2], [254, 180, 31],
                [254, 153, 61], [251, 127, 88], [235, 101, 105], [216, 77, 120],
                [196, 54, 136], [172, 33, 152], [144, 13, 163], [114, 1, 168],
                [82, 2, 165], [47, 7, 164], [13, 8, 135]
            ];
            
            const idx = Math.min(Math.floor(intensity * (plasmaColors.length -1)), plasmaColors.length - 1);
            const rgb = plasmaColors[idx];
            return `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        }
        
        // NEW function to aggregate data for 'All Types'
        function aggregateAllTypesData(data) {
            const aggregated = {};
            if (!data.RAZE) return aggregated;

            const binSizes = Object.keys(data.RAZE); // e.g., ['bin_10', 'bin_20', ...]

            binSizes.forEach(binKey => {
                aggregated[binKey] = {};
                const allMaterials = new Set([...Object.keys(data.RAZE[binKey]), ...Object.keys(data.EXTDEM[binKey]), ...Object.keys(data.INTDEM[binKey])]);

                allMaterials.forEach(material => {
                    aggregated[binKey][material] = {};
                    const allLifespanBins = new Set([
                        ...Object.keys(data.RAZE[binKey][material] || {}),
                        ...Object.keys(data.EXTDEM[binKey][material] || {}),
                        ...Object.keys(data.INTDEM[binKey][material] || {})
                    ]);

                    allLifespanBins.forEach(lifespanBin => {
                        const razeCount = data.RAZE[binKey][material]?.[lifespanBin] || 0;
                        const extdemCount = data.EXTDEM[binKey][material]?.[lifespanBin] || 0;
                        const intdemCount = data.INTDEM[binKey][material]?.[lifespanBin] || 0;
                        aggregated[binKey][material][lifespanBin] = razeCount + extdemCount + intdemCount;
                    });
                });
            });
            return aggregated;
        }

        // Create heatmap visualization
        function createHeatmap(demoType, binSize, displayMode) {
            const binKey = `bin_${binSize}`;
            // Use the aggregated 'all' data source if specified
            const demoData = currentData.material_lifespan_demo[demoType];
            
            if (!demoData || !demoData[binKey]) {
                console.error(`No data for ${demoType} with bin size ${binSize}`);
                document.getElementById('heatmapContent').innerHTML = `<div class="error-message">No data available for this selection.</div>`;
                return;
            }
            
            const materialData = demoData[binKey];
            
            const materialTotals = {};
            Object.entries(materialData).forEach(([material, lifespans]) => {
                materialTotals[material] = Object.values(lifespans).reduce((sum, val) => sum + val, 0);
            });
            
            const sortedMaterials = Object.entries(materialTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15)
                .map(([material]) => material);
            
            const allLifespanBins = new Set();
            sortedMaterials.forEach(material => {
                Object.keys(materialData[material]).forEach(bin => allLifespanBins.add(bin));
            });
            
            const sortedLifespanBins = Array.from(allLifespanBins).sort((a, b) => {
                const getFirstNum = (str) => parseInt(str.match(/\d+/)?.[0] || 0);
                return getFirstNum(a) - getFirstNum(b);
            });
            
            let maxValue = 0;
            sortedMaterials.forEach(material => {
                Object.values(materialData[material]).forEach(val => {
                    maxValue = Math.max(maxValue, val);
                });
            });
            
            let html = '<div class="heatmap-container">';
            html += '<table class="heatmap-table">';
            html += '<thead><tr>';
            html += '<th class="material-header">Material</th>';
            sortedLifespanBins.forEach(bin => {
                html += `<th>${bin.replace(' years', '')}</th>`;
            });
            html += '<th>Total</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            sortedMaterials.forEach(material => {
                html += '<tr>';
                html += `<td class="material-name">${material}</td>`;
                
                sortedLifespanBins.forEach(bin => {
                    const value = materialData[material]?.[bin] || 0;
                    let displayValue = value;
                    
                    if (displayMode === 'percentage' && value > 0) {
                        const total = materialTotals[material];
                        const pct = total > 0 ? (value / total) * 100 : 0;
                        displayValue = value + ` (${pct.toFixed(1)}%)`;
                    }
                    
                    // Use LINEAR intensity calculation
                    const intensity = maxValue > 0 ? value / maxValue : 0;
                    const bgColor = getPlasmaColor(value, maxValue);
                    const textColor = intensity > 0.6 ? 'white' : '#333';
                    
                    html += `<td style="background-color: ${bgColor}; color: ${textColor};">`;
                    html += `<div class="heatmap-cell">${value > 0 ? displayValue : ''}</div>`;
                    html += '</td>';
                });
                
                const total = materialTotals[material];
                html += `<td style="background-color: #f8f9fa; font-weight: bold;">${total}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += '<div class="heatmap-legend">';
            html += '<div class="legend-gradient">';
            html += '<span>0</span><div class="gradient-bar"></div>';
            html += `<span>${maxValue}</span></div>`;
            html += `<div>Showing: ${demoType.toUpperCase()} demolitions (${displayMode}) - Linear scale colors</div>`;
            html += '</div>';
            
            document.getElementById('heatmapContent').innerHTML = html;
        }

        function setVisualizationType(type) {
            currentVisualization = type;
            document.getElementById('heatmapBtn').classList.toggle('active', type === 'heatmap');
            document.getElementById('stackedBtn').classList.toggle('active', type === 'stacked');
            updateVisualization();
        }

        function updateVisualization() {
            if (!currentData) return;
            
            const binSize = parseInt(document.getElementById('lifespanBinSize').value);
            const displayMode = document.getElementById('viewMode').value;
            
            if (currentVisualization === 'heatmap') {
                document.getElementById('heatmapContainer').classList.remove('hidden');
                document.getElementById('allChartContainer').classList.add('hidden');
                document.getElementById('razeChartContainer').classList.add('hidden');
                document.getElementById('extdemChartContainer').classList.add('hidden');
                document.getElementById('intdemChartContainer').classList.add('hidden');
                
                const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
                createHeatmap(demolitionView, binSize, displayMode);
            } else {
                document.getElementById('heatmapContainer').classList.add('hidden');
                updateDemolitionView(); // This will show the correct stacked chart
            }
        }

        // Function to calculate average lifespan for selected demolition type
        function calculateAverageLifespan(demolitionType) {
            if (!currentData || !currentData.material_lifespan_demo_avg) return null;
            
            if (demolitionType === 'all') {
                return currentData.summary_stats.average_lifespan;
            }
            
            return currentData.material_lifespan_demo_avg[demolitionType] || null;
        }

        // Function to update stats based on demolition type
        function updateStats(demolitionType) {
            if (!currentData) return;
            
            // Update average lifespan based on demolition type
            const avgLifespan = calculateAverageLifespan(demolitionType);
            const avgLifespanLabel = document.getElementById('avgLifespanLabel');
            const avgLifespanValue = document.getElementById('avgLifespan');
            
            if (demolitionType === 'all') {
                avgLifespanLabel.textContent = 'Average Lifespan (All Types)';
            } else {
                avgLifespanLabel.textContent = `Average Lifespan (${demolitionType})`;
            }
            
            if (avgLifespan !== null) {
                avgLifespanValue.textContent = avgLifespan.toFixed(1) + ' yrs';
            } else {
                avgLifespanValue.textContent = 'N/A';
            }
        }

        async function loadDataFromJSON() {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const mainContent = document.getElementById('mainContent');
            
            try {
                const response = await fetch('boston_demolition_data.json');
                if (!response.ok) throw new Error(`Failed to load data file: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                if (!data.material_lifespan_demo) throw new Error('Missing required data: material_lifespan_demo');
                
                currentData = data;
                // Pre-calculate the 'all' demolition type data
                currentData.material_lifespan_demo.all = aggregateAllTypesData(data.material_lifespan_demo);
                
                loadingContainer.style.display = 'none';
                mainContent.style.display = 'block';
                
                document.querySelector('input[name="demolitionView"][value="RAZE"]').checked = true;
                
                document.getElementById('heatmapBtn').addEventListener('click', () => setVisualizationType('heatmap'));
                document.getElementById('stackedBtn').addEventListener('click', () => setVisualizationType('stacked'));
                
                updateDashboard(data);
                console.log('Successfully loaded Boston demolition data');
                
            } catch (error) {
                console.error('Error loading data:', error);
                loadingContainer.style.display = 'none';
                errorContainer.innerHTML = `<div class="error-message"><strong>Error Loading Data:</strong><br>${error.message}</div>`;
            }
        }

        function updateDashboard(data) {
            document.getElementById('totalDemo').textContent = data.summary_stats.total_demolitions.toLocaleString();

            const defaultAvgLifespan = data.material_lifespan_demo_avg && data.material_lifespan_demo_avg.RAZE 
                ? data.material_lifespan_demo_avg.RAZE 
                : data.summary_stats.average_lifespan;
            document.getElementById('avgLifespan').textContent = defaultAvgLifespan.toFixed(1) + ' yrs';
            document.getElementById('avgLifespanLabel').textContent = 'Average Lifespan (RAZE)';
            document.getElementById('extdemCount').textContent = data.summary_stats.extdem_count.toLocaleString();
            document.getElementById('intdemCount').textContent = data.summary_stats.intdem_count.toLocaleString();
            document.getElementById('razeCount').textContent = data.summary_stats.raze_count.toLocaleString();
            
            if (data.metadata) {
                document.getElementById('totalMABuildings').textContent = data.metadata.total_ma_buildings.toLocaleString();
                document.getElementById('bostonDemolitions').textContent = data.metadata.total_boston_demolitions.toLocaleString();
                document.getElementById('validRecords').textContent = data.summary_stats.total_demolitions.toLocaleString();
                document.getElementById('dateRange').textContent = data.metadata.year_range;

                if (document.getElementById('yearBuiltRange')) {
                    document.getElementById('yearBuiltRange').textContent = data.metadata.year_built_range || '1940-present';
                }
            }

            if (data.material_stats) {
                const tbody = document.getElementById('materialTableBody');
                tbody.innerHTML = '';
                data.material_stats.slice(0, 10).forEach(mat => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = mat.material;
                    row.insertCell(1).textContent = mat.count.toLocaleString();
                    row.insertCell(2).textContent = mat.avg_lifespan.toFixed(1) + ' yrs';
                    row.insertCell(3).textContent = mat.demolition_breakdown.INTDEM;
                    row.insertCell(4).textContent = mat.demolition_breakdown.EXTDEM;
                    row.insertCell(5).textContent = mat.demolition_breakdown.RAZE;
                });
            }

            if (data.city_stats) {
                const cityGrid = document.getElementById('cityGrid');
                cityGrid.innerHTML = '';
                data.city_stats.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'city-item';
                    div.innerHTML = `<div class="city-name">${city.city}</div><div class="city-count">${city.count.toLocaleString()} demolitions</div>`;
                    cityGrid.appendChild(div);
                });
            }

            setVisualizationType('heatmap'); // Start with heatmap view
            createYearlyChart(data.yearly_stacked);
            createLifespanChart(data);
            
            // Update boxplot with initial demolition type
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            createMaterialBoxplot(data, demolitionView);
            updateStats('RAZE');
        }

        function updateDemolitionView() {
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            
            // Update the average lifespan stat
            updateStats(demolitionView);
            
            if (currentVisualization === 'stacked') {
                document.getElementById('allChartContainer').classList.toggle('hidden', demolitionView !== 'all');
                document.getElementById('razeChartContainer').classList.toggle('hidden', demolitionView !== 'RAZE');
                document.getElementById('extdemChartContainer').classList.toggle('hidden', demolitionView !== 'EXTDEM');
                document.getElementById('intdemChartContainer').classList.toggle('hidden', demolitionView !== 'INTDEM');
                updateStackedBarCharts();
            } else {
                 updateVisualization();
            }
            
            if (currentData) {
                createYearlyChart(currentData.yearly_stacked);
                createLifespanChart(currentData);
                createMaterialBoxplot(currentData, demolitionView); // Pass demolition type to boxplot
            }
        }

        function updateStackedBarCharts() {
            if (!currentData || !currentData.material_lifespan_demo) return;
            const binSize = parseInt(document.getElementById('lifespanBinSize').value);
            const displayMode = document.getElementById('viewMode').value;
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            createStackedBarChart(demolitionView, binSize, displayMode);
        }

        function createStackedBarChart(demoType, binSize, displayMode) {
            const canvasId = demoType.toLowerCase() + 'Chart';
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return; // Exit if canvas not found
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const binKey = `bin_${binSize}`;
            const demoData = currentData.material_lifespan_demo[demoType];
            
            if (!demoData || !demoData[binKey]) {
                console.error(`No data for ${demoType} with bin size ${binSize}`);
                return;
            }
            
            const materialData = demoData[binKey];
            
            const materialTotals = {};
            Object.entries(materialData).forEach(([material, lifespans]) => {
                materialTotals[material] = Object.values(lifespans).reduce((sum, val) => sum + val, 0);
            });
            
            const sortedMaterials = Object.keys(materialTotals).sort((a, b) => materialTotals[b] - materialTotals[a]);
            
            const lifespanTotals = {};
            sortedMaterials.forEach(material => {
                Object.entries(materialData[material]).forEach(([bin, count]) => {
                    lifespanTotals[bin] = (lifespanTotals[bin] || 0) + count;
                });
            });
            
            const sortedLifespanBins = Object.keys(lifespanTotals).sort((a, b) => lifespanTotals[b] - lifespanTotals[a]);
            
            const colors = getLifespanColors(sortedLifespanBins.length);
            
            const datasets = sortedLifespanBins.map((lifespanBin, index) => {
                const data = sortedMaterials.map(material => {
                    const value = materialData[material]?.[lifespanBin] || 0;
                    if (displayMode === 'percentage') {
                        const total = materialTotals[material];
                        return total > 0 ? (value / total) * 100 : 0;
                    }
                    return value;
                });
                
                return {
                    label: lifespanBin,
                    data: data,
                    backgroundColor: colors[index],
                    borderWidth: 0.5,
                    borderColor: 'rgba(255, 255, 255, 0.5)'
                };
            });
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: { labels: sortedMaterials, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Material Type' } },
                        y: { stacked: true, title: { display: true, text: displayMode === 'percentage' ? 'Percentage (%)' : 'Count' }, max: displayMode === 'percentage' ? 100 : undefined }
                    },
                    plugins: {
                        legend: { display: true, position: 'right', reverse: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${label}: ${displayMode === 'percentage' ? value.toFixed(1) + '%' : value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createYearlyChart(yearlyData) {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            if (charts.yearly) charts.yearly.destroy();
            
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            const years = yearlyData.map(d => d.year);
            let datasets = [];
            
            if (demolitionView === 'all') {
                const types = [
                    {name: 'RAZE', total: yearlyData.reduce((s, d) => s + (d.RAZE || 0), 0)},
                    {name: 'EXTDEM', total: yearlyData.reduce((s, d) => s + (d.EXTDEM || 0), 0)},
                    {name: 'INTDEM', total: yearlyData.reduce((s, d) => s + (d.INTDEM || 0), 0)}
                ].sort((a, b) => b.total - a.total);

                const sortedColors = ['rgba(13, 8, 135, 0.8)', 'rgba(172, 33, 152, 0.8)', 'rgba(240, 249, 33, 0.8)'];

                types.forEach((type, index) => {
                    datasets.push({
                        label: type.name,
                        data: yearlyData.map(d => d[type.name] || 0),
                        backgroundColor: sortedColors[index]
                    });
                });
            } else {
                datasets.push({
                    label: demolitionView,
                    data: yearlyData.map(d => d[demolitionView] || 0),
                    backgroundColor: 'rgba(13, 8, 135, 0.8)'
                });
            }

            charts.yearly = new Chart(ctx, {
                type: 'bar',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: demolitionView === 'all', title: { display: true, text: 'Year' } },
                        y: { stacked: demolitionView === 'all', title: { display: true, text: 'Count' } }
                    },
                    plugins: {
                        legend: { display: demolitionView === 'all', reverse: true }
                    }
                }
            });
        }

        function createLifespanChart(data) {
            const ctx = document.getElementById('lifespanChart').getContext('2d');
            if (charts.lifespan) charts.lifespan.destroy();
            
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            const lifespanData = data.lifespan_distribution;
            const labels = lifespanData.map(d => d.range);
            let datasets = [];
            
            if (demolitionView === 'all') {
                const types = [
                    {name: 'RAZE', total: lifespanData.reduce((s, d) => s + (d.RAZE || 0), 0)},
                    {name: 'EXTDEM', total: lifespanData.reduce((s, d) => s + (d.EXTDEM || 0), 0)},
                    {name: 'INTDEM', total: lifespanData.reduce((s, d) => s + (d.INTDEM || 0), 0)}
                ].sort((a, b) => b.total - a.total);

                const sortedColors = ['rgba(13, 8, 135, 0.8)', 'rgba(172, 33, 152, 0.8)', 'rgba(240, 249, 33, 0.8)'];
                
                types.forEach((type, index) => {
                    datasets.push({
                        label: type.name,
                        data: lifespanData.map(d => d[type.name] || 0),
                        backgroundColor: sortedColors[index]
                    });
                });
            } else {
                datasets.push({
                    label: demolitionView,
                    data: lifespanData.map(d => d[demolitionView] || 0),
                    backgroundColor: 'rgba(13, 8, 135, 0.8)'
                });
            }

            charts.lifespan = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: demolitionView === 'all', title: { display: true, text: 'Lifespan (years)' } },
                        y: { stacked: demolitionView === 'all', title: { display: true, text: 'Count' } }
                    },
                    plugins: {
                        legend: { display: demolitionView === 'all', reverse: true }
                    }
                }
            });
        }

        function createMaterialBoxplot(data, demolitionType = 'RAZE') {
            const ctx = document.getElementById('boxplotChart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts.boxplot) charts.boxplot.destroy();
            
            // Update title and description
            const titleElement = document.getElementById('boxplotTitle');
            const descriptionElement = document.getElementById('boxplotDescription');
            
            if (demolitionType === 'all') {
                titleElement.textContent = 'Building Lifespan by Material Type (All Demolition Types)';
                descriptionElement.textContent = 'Box plot showing the distribution of building lifespans for each material type across all demolition types';
            } else {
                titleElement.textContent = `Building Lifespan by Material Type (${demolitionType} Only)`;
                descriptionElement.textContent = `Box plot showing the distribution of building lifespans for each material type for ${demolitionType} demolitions`;
            }
            
            // Check if we have the raw lifespan data with demolition types
            if (!data.material_lifespan_raw_by_demo) {
                console.error('No raw lifespan data available for boxplot by demolition type');
                return;
            }
            
            let rawData;
            if (demolitionType === 'all') {
                // Combine all demolition types
                rawData = {};
                const demoTypes = ['RAZE', 'EXTDEM', 'INTDEM'];
                
                demoTypes.forEach(demo => {
                    if (data.material_lifespan_raw_by_demo[demo]) {
                        Object.entries(data.material_lifespan_raw_by_demo[demo]).forEach(([material, values]) => {
                            if (!rawData[material]) {
                                rawData[material] = [];
                            }
                            rawData[material] = rawData[material].concat(values);
                        });
                    }
                });
            } else {
                // Use specific demolition type
                rawData = data.material_lifespan_raw_by_demo[demolitionType];
                
                if (!rawData) {
                    console.error(`No raw lifespan data available for ${demolitionType}`);
                    return;
                }
            }
            
            const materials = Object.keys(rawData);
            
            // Sort materials by median lifespan for better visualization
            materials.sort((a, b) => {
                const medianA = rawData[a].sort((x, y) => x - y)[Math.floor(rawData[a].length / 2)];
                const medianB = rawData[b].sort((x, y) => x - y)[Math.floor(rawData[b].length / 2)];
                return medianB - medianA;
            });
            
            // Limit to top 15 materials by count
            const materialCounts = materials.map(m => ({ material: m, count: rawData[m].length }));
            materialCounts.sort((a, b) => b.count - a.count);
            const top15Materials = materialCounts.slice(0, 15).map(item => item.material);
            
            // Create the boxplot chart
            charts.boxplot = new Chart(ctx, {
                type: 'boxplot',
                data: {
                    labels: top15Materials,
                    datasets: [{
                        label: `Building Lifespan Distribution (${demolitionType === 'all' ? 'All Types' : demolitionType})`,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        outlierColor: 'rgba(255, 99, 132, 1)',
                        outlierBackgroundColor: 'rgba(255, 99, 132, 0.5)',
                        medianColor: 'rgba(255, 159, 64, 1)',
                        data: top15Materials.map(material => rawData[material])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const material = top15Materials[context.dataIndex];
                                    const values = rawData[material].sort((a, b) => a - b);
                                    const q1 = values[Math.floor(values.length * 0.25)];
                                    const median = values[Math.floor(values.length * 0.5)];
                                    const q3 = values[Math.floor(values.length * 0.75)];
                                    const min = Math.min(...values);
                                    const max = Math.max(...values);
                                    const count = values.length;
                                    
                                    return [
                                        `Material: ${material}`,
                                        `Demolition Type: ${demolitionType === 'all' ? 'All Types' : demolitionType}`,
                                        `Count: ${count}`,
                                        `Min: ${min.toFixed(1)} years`,
                                        `Q1: ${q1.toFixed(1)} years`,
                                        `Median: ${median.toFixed(1)} years`,
                                        `Q3: ${q3.toFixed(1)} years`,
                                        `Max: ${max.toFixed(1)} years`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Building Lifespan (years)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Material Type'
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        window.addEventListener('DOMContentLoaded', loadDataFromJSON);
    </script>
</body>
</html>