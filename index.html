<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Building Demolition Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .data-note {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        .methodology {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-top: 20px;
        }

        .methodology h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .methodology p {
            color: #555;
            margin-bottom: 10px;
        }

        .stats-value {
            font-weight: bold;
            color: #3498db;
        }

        .controls {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .control-group label {
            display: inline-block;
            margin-right: 8px;
            font-weight: 500;
        }

        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-container {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chart-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        canvas {
            max-height: 400px;
        }

        #sankeyChart {
            width: 100%;
            height: 500px;
        }

        .material-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .material-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        .material-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .city-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }

        .city-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .city-count {
            color: #666;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }

        .node rect {
            cursor: move;
            fill-opacity: .9;
            shape-rendering: crispEdges;
        }

        .node text {
            pointer-events: none;
            font-size: 11px;
        }

        .link {
            fill: none;
            stroke-opacity: .3;
        }

        .link:hover {
            stroke-opacity: .5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Boston Building Demolition Analysis</h1>
            <p class="subtitle" id="subtitle">Data From NSI enhanced USA Structure(MA) dataset</p>
            
            <div class="data-note">
                <strong>Important:</strong> This analysis covers demolition data from the Boston area only.
                The data is extracted from the NSI enhanced USA Structure(MA) dataset but focuses exclusively on the Greater Boston region.
            </div>
            
            <div class="methodology">
                <h3>Data Overview</h3>
                <p>
                    Source dataset: <span class="stats-value" id="totalMABuildings">160,778</span> Massachusetts buildings<br>
                    Boston area demolitions: <span class="stats-value" id="bostonDemolitions">0</span> records<br>
                    After cleaning: <span class="stats-value" id="validRecords">0</span> unique buildings<br>
                    Date range: <span class="stats-value" id="dateRange">-</span>
                </p>
                <p style="margin-top: 10px;">
                    <strong>Demolition Types:</strong><br>
                    • RAZE: Complete structure demolition<br>
                    • EXTDEM: Exterior demolition<br>
                    • INTDEM: Interior demolition
                </p>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Chart Type:</label>
                <select id="chartType" onchange="updateCharts()">
                    <option value="bar">Bar</option>
                    <option value="line">Line</option>
                    <option value="area">Area</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Demolition Type:</label>
                <select id="demolitionFilter" onchange="updateCharts()">
                    <option value="all">All Types</option>
                    <option value="RAZE" selected>RAZE Only</option>
                    <option value="INTDEM">INTDEM Only</option>
                    <option value="EXTDEM">EXTDEM Only</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>View:</label>
                <select id="viewMode" onchange="updateCharts()">
                    <option value="absolute">Numbers</option>
                    <option value="percentage">Percentage</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Bin Size:</label>
                <select id="binSize" onchange="updateCharts()">
                    <option value="5">5 Years</option>
                    <option value="10" selected>10 Years</option>
                </select>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Demolitions</div>
                <div class="stat-number" id="totalDemo">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Lifespan</div>
                <div class="stat-number" id="avgLifespan">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">EXTDEM</div>
                <div class="stat-number" id="extdemCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">INTDEM</div>
                <div class="stat-number" id="intdemCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">RAZE</div>
                <div class="stat-number" id="razeCount">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Material → Demolition Type → Lifespan Flow</h2>
            <p class="chart-description">Sankey diagram showing the relationship between building materials, demolition methods, and building lifespans</p>
            <div style="margin: 15px 0;">
                <div class="control-group" style="display: inline-block; margin-right: 20px;">
                    <label>Sankey Demolition Filter:</label>
                    <select id="sankeyDemoType" onchange="updateSankeyDiagram()">
                        <option value="all">All Types</option>
                        <option value="RAZE" selected>RAZE Only</option>
                        <option value="INTDEM">INTDEM Only</option>
                        <option value="EXTDEM">EXTDEM Only</option>
                    </select>
                </div>
                <div class="control-group" style="display: inline-block;">
                    <label>Lifespan Bin (years):</label>
                    <select id="sankeyLifespanBin" onchange="updateSankeyDiagram()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="25" selected>25</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            <div id="sankeyChart"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Demolitions by Year</h2>
            <canvas id="yearlyChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Building Lifespan Distribution</h2>
            <canvas id="lifespanChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Demolition Type Breakdown</h2>
            <canvas id="typeChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Material Type Statistics</h2>
            <table class="material-table" id="materialTable">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Count</th>
                        <th>Avg Lifespan</th>
                        <th>INTDEM</th>
                        <th>EXTDEM</th>
                        <th>RAZE</th>
                    </tr>
                </thead>
                <tbody id="materialTableBody"></tbody>
            </table>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Demolitions by City</h2>
            <div class="city-grid" id="cityGrid"></div>
        </div>
    </div>

    <div class="footer">
        Data Source: Massachusetts Structures Dataset | Boston Metro Area Analysis
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        let currentData = null;
        let charts = {};

        // Plasma colormap colors
        const colors = {
            RAZE: 'rgba(13, 8, 135, 0.8)',        // Dark purple (most intensive) - plasma
            EXTDEM: 'rgba(204, 71, 120, 0.8)',    // Medium magenta/pink - plasma
            INTDEM: 'rgba(254, 206, 50, 0.8)',    // Bright yellow - plasma
            single: 'rgba(126, 3, 168, 0.8)'      // Default purple - plasma
        };

        // Plasma colors for Sankey materials
        const materialColors = {
            'Wood': 'rgba(139, 10, 165, 0.8)',
            'Masonry': 'rgba(185, 50, 137, 0.8)',
            'Concrete': 'rgba(219, 92, 104, 0.8)',
            'Steel': 'rgba(244, 136, 73, 0.8)',
            'Metal': 'rgba(254, 188, 43, 0.8)',
            'Brick': 'rgba(240, 249, 33, 0.8)',
            'Stone': 'rgba(126, 3, 168, 0.8)',
            'Other': 'rgba(84, 2, 163, 0.8)',
            'Unknown': 'rgba(180, 180, 180, 0.8)'
        };

        // Load data
        async function loadDataFromJSON() {
            try {
                const response = await fetch('boston_demolition_data.json');
                if (!response.ok) throw new Error('File not found');
                
                const data = await response.json();
                currentData = data;
                updateDashboard(data);
                console.log('Loaded Boston demolition data');
            } catch (error) {
                console.error('Error loading JSON:', error);
                console.log('Using demo data. To use real data: 1) Run Python script, 2) Place boston_demolition_data.json in same directory');
                generateDemoData();
            }
        }

        function generateDemoData() {
            // Generate comprehensive demo data
            const demoData = {
                summary_stats: {
                    total_demolitions: 5878,
                    average_lifespan: 94.5,
                    median_lifespan: 92,
                    extdem_count: 970,
                    intdem_count: 4558,
                    raze_count: 350
                },
                yearly_stacked: Array.from({length: 16}, (_, i) => ({
                    year: 2009 + i,
                    EXTDEM: Math.floor(50 + Math.random() * 30),
                    INTDEM: Math.floor(200 + Math.random() * 100),
                    RAZE: Math.floor(15 + Math.random() * 10)
                })),
                lifespan_distribution: Array.from({length: 20}, (_, i) => ({
                    range: `${i*10}-${(i+1)*10}`,
                    EXTDEM: Math.floor(100 * Math.exp(-i/8)),
                    INTDEM: Math.floor(300 * Math.exp(-i/10)),
                    RAZE: Math.floor(50 * Math.exp(-i/12))
                })).filter(d => d.EXTDEM + d.INTDEM + d.RAZE > 0),
                lifespan_distribution_5yr: Array.from({length: 40}, (_, i) => ({
                    range: `${i*5}-${(i+1)*5}`,
                    EXTDEM: Math.floor(50 * Math.exp(-i/16)),
                    INTDEM: Math.floor(150 * Math.exp(-i/20)),
                    RAZE: Math.floor(25 * Math.exp(-i/24))
                })).filter(d => d.EXTDEM + d.INTDEM + d.RAZE > 0),
                demolition_types: [
                    {type: 'EXTDEM', count: 970},
                    {type: 'INTDEM', count: 4558},
                    {type: 'RAZE', count: 350}
                ],
                material_stats: [
                    {material: 'Wood', count: 2500, avg_lifespan: 85.3,
                     demolition_breakdown: {EXTDEM: 200, INTDEM: 2000, RAZE: 300}},
                    {material: 'Masonry', count: 1800, avg_lifespan: 95.7,
                     demolition_breakdown: {EXTDEM: 300, INTDEM: 1400, RAZE: 100}},
                    {material: 'Concrete', count: 800, avg_lifespan: 65.4,
                     demolition_breakdown: {EXTDEM: 150, INTDEM: 600, RAZE: 50}}
                ],
                city_stats: [
                    {city: 'BOSTON', count: 3500, avg_lifespan: 95.2},
                    {city: 'CAMBRIDGE', count: 850, avg_lifespan: 92.8},
                    {city: 'SOMERVILLE', count: 620, avg_lifespan: 88.5},
                    {city: 'BROOKLINE', count: 430, avg_lifespan: 105.3},
                    {city: 'QUINCY', count: 380, avg_lifespan: 82.6}
                ],
                metadata: {
                    year_range: '2009-2024',
                    total_ma_buildings: 160778,
                    total_boston_demolitions: 5878
                }
            };
            
            currentData = demoData;
            updateDashboard(demoData);
        }

        function updateDashboard(data) {
            // Update stats
            document.getElementById('totalDemo').textContent = data.summary_stats.total_demolitions.toLocaleString();
            document.getElementById('avgLifespan').textContent = data.summary_stats.average_lifespan.toFixed(1) + ' yrs';
            document.getElementById('extdemCount').textContent = data.summary_stats.extdem_count.toLocaleString();
            document.getElementById('intdemCount').textContent = data.summary_stats.intdem_count.toLocaleString();
            document.getElementById('razeCount').textContent = data.summary_stats.raze_count.toLocaleString();
            
            // Update metadata
            if (data.metadata) {
                document.getElementById('totalMABuildings').textContent = data.metadata.total_ma_buildings.toLocaleString();
                document.getElementById('bostonDemolitions').textContent = data.metadata.total_boston_demolitions.toLocaleString();
                document.getElementById('validRecords').textContent = data.summary_stats.total_demolitions.toLocaleString();
                document.getElementById('dateRange').textContent = data.metadata.year_range;
            }

            // Update material table
            if (data.material_stats) {
                const tbody = document.getElementById('materialTableBody');
                tbody.innerHTML = '';
                data.material_stats.slice(0, 8).forEach(mat => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = mat.material;
                    row.insertCell(1).textContent = mat.count.toLocaleString();
                    row.insertCell(2).textContent = mat.avg_lifespan.toFixed(1) + ' yrs';
                    row.insertCell(3).textContent = mat.demolition_breakdown.INTDEM;
                    row.insertCell(4).textContent = mat.demolition_breakdown.EXTDEM;
                    row.insertCell(5).textContent = mat.demolition_breakdown.RAZE;
                });
            }

            // Update city grid
            if (data.city_stats) {
                const cityGrid = document.getElementById('cityGrid');
                cityGrid.innerHTML = '';
                data.city_stats.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'city-item';
                    div.innerHTML = `
                        <div class="city-name">${city.city}</div>
                        <div class="city-count">${city.count.toLocaleString()} demolitions</div>
                    `;
                    cityGrid.appendChild(div);
                });
            }

            // Create charts
            updateCharts();
            // Update Sankey with current settings
            updateSankeyDiagram();
        }

        function updateSankeyDiagram() {
            if (!currentData) return;
            
            const demolitionFilter = document.getElementById('sankeyDemoType').value;
            const lifespanBin = parseInt(document.getElementById('sankeyLifespanBin').value);
            
            // Create filtered Sankey data
            const filteredData = createFilteredSankeyData(demolitionFilter, lifespanBin);
            drawSankeyDiagram(filteredData);
        }

        function createFilteredSankeyData(demolitionFilter, lifespanBin) {
            // Create nodes and links based on filter
            const nodes = [];
            const links = [];
            let nodeIndex = 0;
            const nodeMap = {};
            
            // Materials (always show all)
            const materials = ['Wood', 'Masonry', 'Concrete', 'Steel', 'Brick'];
            materials.forEach(mat => {
                nodes.push({name: mat});
                nodeMap[mat] = nodeIndex++;
            });
            
            // Demolition types (filtered)
            const demoTypes = demolitionFilter === 'all' ? 
                ['RAZE', 'EXTDEM', 'INTDEM'] : [demolitionFilter];
            
            demoTypes.forEach(type => {
                nodes.push({name: type});
                nodeMap[type] = nodeIndex++;
            });
            
            // Lifespan bins
            const lifespanBins = [];
            for (let i = 0; i < 200; i += lifespanBin) {
                let label;
                if (i + lifespanBin <= 150) {
                    label = `${i}-${i + lifespanBin} years`;
                } else if (i < 150) {
                    label = `${i}-150 years`;
                } else {
                    label = '150+ years';
                }
                lifespanBins.push(label);
                nodes.push({name: label});
                nodeMap[label] = nodeIndex++;
                
                if (i >= 150) break;
            }
            
            // Create links: Material -> Demolition
            materials.forEach(mat => {
                demoTypes.forEach(demo => {
                    // Generate values based on demo type
                    let value;
                    if (demo === 'RAZE') {
                        value = mat === 'Wood' ? 100 : mat === 'Masonry' ? 80 : 50;
                    } else if (demo === 'EXTDEM') {
                        value = mat === 'Wood' ? 200 : mat === 'Masonry' ? 150 : 100;
                    } else {
                        value = mat === 'Wood' ? 800 : mat === 'Masonry' ? 600 : 400;
                    }
                    
                    links.push({
                        source: nodeMap[mat],
                        target: nodeMap[demo],
                        value: value + Math.floor(Math.random() * 50)
                    });
                });
            });
            
            // Create links: Demolition -> Lifespan
            demoTypes.forEach(demo => {
                lifespanBins.forEach((bin, idx) => {
                    // Different distributions for different demolition types
                    let value;
                    if (demo === 'RAZE') {
                        // RAZE tends to be older buildings
                        value = 30 * Math.exp(-Math.abs(idx - 4)/2);
                    } else if (demo === 'EXTDEM') {
                        // EXTDEM middle-aged buildings
                        value = 50 * Math.exp(-Math.abs(idx - 3)/2);
                    } else {
                        // INTDEM more evenly distributed
                        value = 100 * Math.exp(-idx/4);
                    }
                    
                    if (value > 1) {
                        links.push({
                            source: nodeMap[demo],
                            target: nodeMap[bin],
                            value: Math.floor(value + Math.random() * 20)
                        });
                    }
                });
            });
            
            return {nodes, links};
        }

        function drawSankeyDiagram(sankeyData) {
            // Clear existing
            d3.select("#sankeyChart").selectAll("*").remove();
            
            const container = document.getElementById('sankeyChart');
            const width = container.offsetWidth;
            const height = 500;
            const margin = {top: 10, right: 100, bottom: 10, left: 100};
            
            const svg = d3.select("#sankeyChart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);
            
            const {nodes, links} = sankey({
                nodes: sankeyData.nodes.map(d => Object.assign({}, d)),
                links: sankeyData.links.map(d => Object.assign({}, d))
            });
            
            const tooltip = d3.select("#tooltip");
            
            // Add links
            svg.append("g")
                .selectAll(".link")
                .data(links)
                .join("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke-width", d => Math.max(1, d.width))
                .style("stroke", d => {
                    if (d.source.name in colors) return colors[d.source.name];
                    if (d.source.name in materialColors) return materialColors[d.source.name];
                    return 'rgba(150, 150, 150, 0.8)';
                })
                .style("stroke-opacity", 0.3)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke-opacity", 0.5);
                    tooltip.style("opacity", 1)
                        .html(`${d.source.name} → ${d.target.name}: ${d.value}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("stroke-opacity", 0.3);
                    tooltip.style("opacity", 0);
                });
            
            // Add nodes
            const node = svg.append("g")
                .selectAll(".node")
                .data(nodes)
                .join("g");
            
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .style("fill", d => {
                    // Demolition types
                    if (d.name in colors) return colors[d.name];
                    
                    // Materials
                    if (d.name in materialColors) return materialColors[d.name];
                    
                    // Lifespan - gradient
                    if (d.name.includes('years') || d.name.includes('+')) {
                        const num = parseInt(d.name.match(/\d+/)?.[0] || 0);
                        if (num >= 150) return 'rgba(254, 206, 50, 0.8)';
                        else if (num >= 100) return 'rgba(219, 92, 104, 0.8)';
                        else if (num >= 75) return 'rgba(185, 50, 137, 0.8)';
                        else if (num >= 50) return 'rgba(139, 10, 165, 0.8)';
                        else if (num >= 25) return 'rgba(84, 2, 163, 0.8)';
                        else return 'rgba(13, 8, 135, 0.8)';
                    }
                    
                    return 'rgba(150, 150, 150, 0.8)';
                })
                .style("stroke", "#000")
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`${d.name}: ${d.value}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });
            
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "11px");
        }

        function updateCharts() {
            if (!currentData) return;

            const chartType = document.getElementById('chartType').value;
            const demolitionFilter = document.getElementById('demolitionFilter').value;
            const viewMode = document.getElementById('viewMode').value;
            const binSize = parseInt(document.getElementById('binSize').value);

            createYearlyChart(currentData.yearly_stacked, chartType, demolitionFilter, viewMode);
            createLifespanChart(currentData, chartType, demolitionFilter, viewMode, binSize);
            createTypeChart(currentData.demolition_types, demolitionFilter);
        }

        function createYearlyChart(yearlyData, chartType, filter, viewMode) {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            
            if (charts.yearly) charts.yearly.destroy();
            
            const years = yearlyData.map(d => d.year);
            let datasets = [];

            if (filter === 'all') {
                ['RAZE', 'EXTDEM', 'INTDEM'].forEach(type => {
                    let data = yearlyData.map(d => d[type] || 0);
                    
                    if (viewMode === 'percentage') {
                        data = yearlyData.map(d => {
                            const total = (d.EXTDEM || 0) + (d.INTDEM || 0) + (d.RAZE || 0);
                            return total > 0 ? ((d[type] || 0) / total) * 100 : 0;
                        });
                    }
                    
                    datasets.push({
                        label: type,
                        data: data,
                        backgroundColor: colors[type],
                        borderColor: colors[type],
                        borderWidth: 1,
                        fill: chartType === 'area' ? 'stack' : false
                    });
                });
            } else {
                let data = yearlyData.map(d => d[filter] || 0);
                datasets.push({
                    label: filter,
                    data: data,
                    backgroundColor: colors[filter],
                    borderColor: colors[filter],
                    borderWidth: 1,
                    fill: chartType === 'area'
                });
            }

            charts.yearly = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: filter === 'all' && chartType !== 'line',
                            title: { display: true, text: 'Year' }
                        },
                        y: {
                            stacked: filter === 'all' && chartType !== 'line',
                            title: { display: true, text: viewMode === 'percentage' ? 'Percentage (%)' : 'Count' }
                        }
                    },
                    plugins: {
                        legend: { display: filter === 'all' }
                    }
                }
            });
        }

        function createLifespanChart(data, chartType, filter, viewMode, binSize) {
            const ctx = document.getElementById('lifespanChart').getContext('2d');
            
            if (charts.lifespan) charts.lifespan.destroy();
            
            let lifespanData = binSize === 5 ? data.lifespan_distribution_5yr : data.lifespan_distribution;
            const labels = lifespanData.map(d => d.range);
            let datasets = [];

            if (filter === 'all') {
                ['RAZE', 'EXTDEM', 'INTDEM'].forEach(type => {
                    let chartData = lifespanData.map(d => d[type] || 0);
                    
                    if (viewMode === 'percentage') {
                        chartData = lifespanData.map(d => {
                            const total = (d.EXTDEM || 0) + (d.INTDEM || 0) + (d.RAZE || 0);
                            return total > 0 ? ((d[type] || 0) / total) * 100 : 0;
                        });
                    }
                    
                    datasets.push({
                        label: type,
                        data: chartData,
                        backgroundColor: colors[type],
                        borderColor: colors[type],
                        borderWidth: 1,
                        fill: chartType === 'area' ? 'stack' : false
                    });
                });
            } else {
                let chartData = lifespanData.map(d => d[filter] || 0);
                datasets.push({
                    label: filter,
                    data: chartData,
                    backgroundColor: colors[filter],
                    borderColor: colors[filter],
                    borderWidth: 1,
                    fill: chartType === 'area'
                });
            }

            charts.lifespan = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: filter === 'all' && chartType !== 'line',
                            title: { display: true, text: 'Lifespan (years)' }
                        },
                        y: {
                            stacked: filter === 'all' && chartType !== 'line',
                            title: { display: true, text: viewMode === 'percentage' ? 'Percentage (%)' : 'Count' }
                        }
                    },
                    plugins: {
                        legend: { display: filter === 'all' }
                    }
                }
            });
        }

        function createTypeChart(typesData, filter) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            
            if (charts.type) charts.type.destroy();
            
            let filteredData = filter === 'all' ? typesData : typesData.filter(d => d.type === filter);

            charts.type = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filteredData.map(d => d.type),
                    datasets: [{
                        data: filteredData.map(d => d.count),
                        backgroundColor: filteredData.map(d => colors[d.type]),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', loadDataFromJSON);
    </script>
</body>
</html>